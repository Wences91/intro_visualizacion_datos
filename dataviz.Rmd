---
title: 'Aprende a hacer gr√°ficos a medida e interactivos en R'
author: 'Wenceslao Arroyo-Machado<br><a href="https://twitter.com/Wences91" style="font-size: 14px">@Wences91</a>'
date: '`r Sys.Date()`'
output:
  html_document:
    css: style.css
    theme: journal
    highlight: zenburn
    toc: yes
    toc_float: yes
    number_sections: yes
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

El objetivo de esta notebook es aprender los pilares de `ggplot2` para realizar gr√°ficos en R y los de `plotly` para generar gr√°ficos interactivos y publicarlos online a trav√©s de [Chart Studio](https://chart-studio.plotly.com/).

Antes de continuar, te aconsejo que antes de lanzarte a probar gr√°ficos a lo loco, tengas claro que tipos de datos tienes y cu√°les ser√≠an las mejores visualizaciones para ello. Aqu√≠ tienes [esta web](https://datavizproject.com/) que te puede ser de ayuda.

# Preparaci√≥n

Los paquetes necesarios para ejecutar esta notebook son los siguientes.

```{r packages, warning=FALSE, message=FALSE}
library(ggplot2)
library(plotly)
library(dplyr)
library(viridis)
```

![](images/pokemon_logo.png)

Para esta ocasi√≥n trabajaremos con un [dataset de Pok√©mon](https://www.kaggle.com/datasets/rounakbanik/pokemon) que incluye los 802 Pok√©mon de las siete generaciones con sus atributos.

```{r data}
df <- read.csv('data/pokemon.csv')
head(df)
```

# ggplot2

## Introducci√≥n

**ggplot2** es un potente paquete para la elaboraci√≥n de gr√°ficos en R y que funciona a trav√©s de *pipelines* (el operador pipeline es `+`\`). Dentro de este flujo de trabajo existen varias funciones y par√°metros que son fundamentales para la elaboraci√≥n de un gr√°fico:

-   **ggplot()** - funci√≥n base para la construcci√≥n del gr√°fico

-   **geom** - funciones que especifican el tipo de representaci√≥n de los datos (puntos, l√≠neas, boxplots...) y se a√±aden al gr√°fico base mediante capas

-   **data** - par√°metro que indica el dataframe a partir del cual se construir√° el gr√°fico

-   **aes()** - funci√≥n en la que se especifican qu√© variables del dataframe se incluyir√°n en el gr√°fico y c√≥mo

De esta forma, para construir por ejemplo un gr√°fico *scatter plot* con nuestro datset de Pok√©mon en el que queremos colocar los puntos de ataque (*attack*) en el eje x y los de defensa (*defense*) en el eje y, realizar√≠amos lo siguiente. Date cuenta de que por defecto ordena ambos ejes de menor a mayor ü§î.

```{r ejemplo_1}
ggplot(data=df, aes(x=attack, y=defense)) +
  geom_point()
```

Todo lo especificado en `ggplot()` es heredado por el resto de funciones, aunque es posible pasar directamente los datos y variables en las funciones geom que usemos (√∫til para combinar diferentes visualizaciones, como veremos m√°s adelante ü§´).

```{r ejemplo_2}
ggplot() +
  geom_point(data=df, aes(x=attack, y=defense))
```

Es posible introducir en `aes()` tambi√©n una tercera o cuarta variable para establecer tama√±os o colores. Aunque en funci√≥n del geom que estemos usando puede tener variaciones. Consulta para ello la ayuda de cada funci√≥n üßê.

```{r help_geom}
help('geom_point')
```

En base a lo que admite `geom_point()` voy a incluir la en color la defensa (*defense*) y en tama√±o los puntos de vida (*hp*).

```{r ejemplo_3}
ggplot(data=df, aes(x=attack, y=defense, color=base_total, size=hp)) +
  geom_point()
```

Estos par√°metros no tienen que estar asociados a una variable, pueden ser una constante. Por ejemplo, se puede indicar que el tama√±o sea en todos los casos el mismo valor. Aunque debes indicarlo directamente en la funci√≥n geom correspondiente y fuera de `aes()`.

```{r ejemplo_4}
ggplot(data=df, aes(x=attack, y=defense)) +
  geom_point(size=2, color='#ffc83d')
```

Algunos apuntes importantes antes de continuar:

1.  Es posible generar el gr√°fico en una variable para facilitar distintas pruebas ahorrando c√≥digo.

```{r ejemplo_5}
df_plot <- ggplot(data=df, aes(x=attack, y=defense, color=base_total))

df_plot +
  geom_point(size=2)
```

2.  Ten en cuenta que tipo de variable tienes, confundir variables discretas y continuas es com√∫n ü§ï. Si tenemos un variable de tipo `integer` autom√°ticamente la tomara como continua, pero si es discreta tenemos que modificarla antes.

    ```{r ejemplo_6}
    ggplot(data=df, aes(x=attack, y=defense, color=generation)) +
      geom_point(size=2)

    df$generation <- as.character(df$generation)
    ggplot(data=df, aes(x=attack, y=defense, color=generation)) +
      geom_point(size=2)
    ```

3.  Combinar dos gr√°ficos (capas) es muy sencillo, solo tienes que a√±adir dos geoms en el orden que quieras. Pero ten en cuenta que variables quieres usar, pues es posible que tengas que especificarlas directamente dentro de estas. ü´£Atenci√≥n a que no existan problemas con las escalas al combinar.

```{r ejemplo_7}
ggplot() +
  geom_line(data=df, aes(x=pokedex_number, y=hp), color='#f47267') +
  geom_line(data=df, aes(x=pokedex_number, y=defense), color='#5880ab')
```

4.  Es posible dividir el gr√°fico en paneles de acuerdo a una variable con `facet_wrap()`. En esta funci√≥n especificas qu√© variable enfrentas a otra/s. Por ejemplo, el gr√°fico anterior dividirlo por generaci√≥n (*generation*).

```{r ejemplo_8}
ggplot() +
  geom_line(data=df, aes(x=pokedex_number, y=hp), color='#f47267') +
  geom_line(data=df, aes(x=pokedex_number, y=defense), color='#5880ab') +
  facet_wrap(.~generation, scales='free')
```

## geoms

Ahora que ya conocemos un poco la forma de trabajar b√°sica de `ggplot2`, vamos a revisar los principales gr√°ficos que podemos hacer.

### L√≠neas - geom_line() y geom_smooth()

Podemos construir gr√°ficos de lineas con `geom_line()`, de manera obligatoria es necesario indicar la posici√≥n de x e y. Por ejemplo, la evoluci√≥n del ataque (*attack*) de los Pok√©mon por orden de posici√≥n en la Pok√©dex (*pokedex_number*), coloreando las l√≠neas en base a la generaci√≥n (*generation*).

```{r ejemplo_9}
ggplot(data=df, aes(x=pokedex_number, y=attack, color=generation)) +
  geom_line()
```

Es posible hacer lineas de regresi√≥n mediante `geom_smooth()`. Por defecto estimar√° el tipo de regresi√≥n que mejor se ajusta.

```{r ejemplo_10}
ggplot(data=df, aes(x=pokedex_number, y=attack, color=generation)) +
  geom_line() +
  geom_smooth()
```

F√≠jate en el ejemplo, que agrupa por generaci√≥n porque de base le digo que establezca dicha diferencia ü•¥. Si quisiera una l√≠nea de regresi√≥n general, una opci√≥n ser√≠a hacer esa distinci√≥n de color espec√≠fica de `geom_line()`.

```{r ejemplo_11}
ggplot(data=df, aes(x=pokedex_number, y=attack)) +
  geom_line(aes(color=generation)) +
  geom_smooth()
```

### Puntos - geom_point()

Esta opci√≥n ya la vimos antes, para hacer un *scatter plot* solo tenemos que usar `geom_point()` y de manera obligatoria incluir las posiciones de x e y. Por ejemplo, el ataque (*attack*) en x y el ataque especial (*sp_attack*) en y, coloreo si es legendario o no (*is_legendary*)\**.*

\*antes tengo que transformarla en discreta ü§´

```{r ejemplo_12}
df$is_legendary <- as.character(df$is_legendary)

ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point()
```

### Barras - geom_bar() y geom_col()

Aqu√≠ tenemos dos opciones. Por un lado, `geom_bar()` permite generar barras de frecuencia a partir de una variable. Solo necesitas especificar la variable en x o y. Por ejemplo, la frecuencia de Pok√©mon por primer tipo (*type1*).

```{r ejemplo_13}
ggplot(data=df, aes(x=type1)) +
  geom_bar()
```

Mientras que en `geom_col()` en lugar de calcular la funci√≥n la altura en base a la frecuencia, esta debe venir dada. Es necesario indicar tanto x como y. Para este ejemplo voy a crear un dataframe nuevo con los promedios de ataque por tipo 1 y voy a indicar que use ese promedio para el color. üî• En este caso el color viene dado por `fill` ya que `color` sirve para el contorno.

```{r ejemplo_14}
df_avg <- df[,c('type1', 'attack')] %>%
  group_by(type1) %>%
  summarise(attack = mean(attack))

ggplot(data=df_avg, aes(x=type1, y=attack, fill=attack)) +
  geom_col()
```

### Histograma - geom_histogram()

Realizar un histograma es muy sencillo üôÇ con la funci√≥n `geom_histogram()`. Solo es necesario indicar la variable en x o y. Puedes establecer el n√∫mero de *bins* con el par√°metro `bins`. Por ejemplo, el histograma de velocidad (*speed*) de los Pok√©mon usando 10 bins.

```{r ejemplo_15}
ggplot(data=df, aes(x=speed)) +
  geom_histogram(bins=10)
```

### Boxplot - geom_boxplot()

Los diagramas de cajas y bigotes son un cl√°sico y aqu√≠ puedes hacerlo con `geom_boxplot()`. Solo necesitas indicar la variable en x o y. Aunque ojo üëÅÔ∏è‚Äçüó®Ô∏è ya que puedes dividir esta variable de acuerdo a una segunda dada. Por ejemplo, el ataque especial (*sp_attack*) por primer tipo (*type1*).

```{r ejemplo_16}
ggplot(data=df, aes(x=type1, y=sp_attack)) +
  geom_boxplot()
```

## Personalizaci√≥n

### Etiquetas

Como te estar√°s dando cuenta, en gr√°ficos como los de puntos no aparecen las etiquetas con los nombres. Introducirlo es muy sencillo con `geom_text()`, indicando en el par√°metro `label` la variable de texto a usar. Por ejemplo, incluir en gr√°fico del inicio los nombres de los Pok√©mon (*name*) con m√°s de 130 de ataque y defensa (para que sea legible üòµ).

```{r ejemplo_17}
ggplot(data=df, aes(x=attack, y=defense, color=base_total)) +
  geom_point() +
  geom_text(data=df[which(df$attack>130 & df$defense>130),], aes(x=attack, y=defense, label=name))
```

### Colores

Podemos establecer escalas de color de forma manual una vez indicado que esta escala viene dada por una variable. En el caso de variables continuas puedes usar `scale_color_gradient()` para establecer un degradado de color.

```{r ejemplo_18}
ggplot(data=df, aes(x=attack, y=defense, color=base_total)) +
  geom_point() +
  scale_color_gradient(low='#5880ab', high='#f47267')
```

De hecho, existen muchos paquetes complementarios a `ggplot2` que a√±aden muchas posibilidades. Por ejemplo, con `viridis` podemos usar la tradicional escala de colores con la funci√≥n `scale_color_viridis()`.

```{r ejemplo_19}
ggplot(data=df, aes(x=attack, y=defense, color=base_total)) +
  geom_point() +
  scale_color_viridis()
```

En el caso de variable discretas es muy sencillo, con `scale_color_manual()` podemos hacerlo simplemente indicando en `values` a qu√© valor corresponde cada color.

```{r ejemplo_20}
ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25'))
```

### Nombres

Por si no te diste cuenta, estos gr√°ficos incluyen por defecto los nombres de las variables en los ejes üôÉ. Este problema se soluciona r√°pidamente con `labs()` indicando para cada variable el nombre exacto que queremos, e incluso podemos introducir un t√≠tulo.

```{r ejemplo_21}
ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25')) +
  labs(x='Ataque', y='Ataque especial', title='Scatter plot de ataque y ataque especial de los Pok√©mon', color='Legendario')
```

### Temas

A tu gr√°fico ya le queda poco para ser pro ü•≥. Puedes usar alguno de los temas que `ggplot2` incluye para mejorar el estilo del gr√°fico. Yo voy a usar `theme_classic()`.

```{r ejemplo_22}
ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25')) +
  labs(x='Ataque', y='Ataque especial', title='Scatter plot de ataque y ataque especial de los Pok√©mon', color='Legendario') +
  theme_classic()
```

### Editor visual

Antes de que desesperes tratando de configurar tu gr√°fico al mil√≠metro, has de saber que existen otros paquetes de ayuda que despliegan menus interactivos para configurar tu gr√°fico en `ggplot2` como [`ggThemeAssist`](https://github.com/calligross/ggthemeassist).

# plotly

En `plotly` puedes realizar gr√°ficos interactivos e incluso publicarlos online en [Chart Studio](https://chart-studio.plotly.com/). Se trata de un paquete muy √∫til y f√°cil de manejar.

## Gr√°ficos interactivos

Gracias a este paquete es posible generar gr√°ficos interactivos pudiendo explorar al detalle las visualizaciones. De manera b√°sica se pueden introducir cajas con informaci√≥n que se despliegan al pasar el rat√≥n sobre los elementos del gr√°fico usando el par√°metro `hovertemplate`.

```{r ejemplo_23, warning=FALSE}
plot_ly(data=df, x=~attack, y=~sp_attack, color=~is_legendary,
        type='scatter', mode='markers',
        text=~name,
        hovertemplate = 'Nombre: %{text}<br>Ataque: %{x}<br>Ataque especial: %{y}<extra></extra>')
```

Existe todo un mundo de posibilidades, pudiendo incorporar elementos como selectores, botones, filtros...

```{r ejemplo_24, warning=FALSE}
plot_ly(data=df, x=~attack, y=~sp_attack, color=~is_legendary,
        type='scatter', mode='markers',
        text=~name,
        hovertemplate = 'Nombre: %{text}<br>Ataque: %{x}<br>Ataque especial: %{y}<extra></extra>') %>%
  rangeslider(c(40, 180))
```

## Gr√°ficos nativos

A la hora de realizar estos gr√°ficos, por un lado, puedes construir gr√°ficos usando solamente `plotly` y mediante una sintaxis muy similar a la de `ggplot2`. De manera general se usa siempre la funci√≥n `plot_ly()` y dentro el data.frame en `data`, los ejes x y/o y, color... y el tipo de gr√°fico se especifica a trav√©s de los par√°metros `type` y `mode`.

### L√≠neas

Solo tienes que indicar en `type` el tipo scatter y en `mode` lines.

```{r ejemplo_25}
plot_ly(data=df, x=~pokedex_number, y=~attack, color=~generation, type='scatter', mode='lines')
```

### Puntos

Solo tienes que indicar en `type` el tipo scatter y en `mode` marks.

```{r ejemplo_26, warning=FALSE}
plot_ly(data=df, x=~attack, y=~sp_attack, color=~is_legendary, type='scatter', mode='markers')
```

### Barras

Solo tienes que indicar en `type` el tipo bar.

```{r ejemplo_27, warning=FALSE}
plot_ly(data=df_avg, x=~type1, y=~attack, color=~attack, type='bar')
```

### Histograma

Solo tienes que indicar en `type` el tipo histogram.

```{r ejemplo_28}
plot_ly(data=df, x=~speed, type='histogram', nbinsx=10)
```

### Boxplot

Solo tienes que indicar en `type` el tipo box

```{r ejemplo_29}
plot_ly(data=df, x=~type1, y=~sp_attack, type='box')
```

## Convertir desde ggplot2

Pero una opci√≥n que te puede venir mucho mejor es convertir directamente en gr√°fico interactivo el gr√°fico que ya ten√≠as en `ggplot2` con la funci√≥n `ggplotly()`. Por ejemplo, vamos a probar con el √∫ltimo gr√°fico que hicimos con `ggplot2`.

```{r ejemplo_30}
gg2 <- ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25')) +
  labs(x='Ataque', y='Ataque especial', title='Scatter plot de ataque y ataque especial de los Pok√©mon', color='Legendario') +
  theme_classic()

ggplotly(gg2)
```

En este caso, para que aparezca el nombre tenemos que introducir dicha variable ya directamente en `ggplot2`.

```{r ejemplo_31}
gg2 <- ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary, text=name)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25')) +
  labs(x='Ataque', y='Ataque especial', title='Scatter plot de ataque y ataque especial de los Pok√©mon', color='Legendario') +
  theme_classic()

ggplotly(gg2)
```

Y en el caso de querer personalizar mejor el cuadro de texto, una opci√≥n es jugar con el par√°metro `text` en `ggplot()` y con `tooltip` en `ggplotly()`.

```{r ejemplo_32}
gg2 <- ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary, text=paste('<b>Nombre:</b>',name, '<br><b>Ataque:</b>', attack, '</b>', '<br><b>Ataque especial:</b>', sp_attack, '</b>'))) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25')) +
  labs(x='Ataque', y='Ataque especial', title='Scatter plot de ataque y ataque especial de los Pok√©mon', color='Legendario') +
  theme_classic()

ggplotly(gg2,
         tooltip = 'text')
```

## Publicaci√≥n

¬øY c√≥mo puedo subirlo a alg√∫n sitio? Muy f√°cil, reg√≠strate en en [Chart Studio](https://chart-studio.plotly.com/) y obt√©n tu clave de la API. Tras ello introduce tus credenciales en la sesi√≥n de R.

```{r api_plotly}
Sys.setenv('plotly_username'='Wences91')
Sys.setenv('plotly_api_key'='LaPmMF2lt51nQFyqE5j4')
```

Tras ello usa la funci√≥n `api_create()` para crearlo [üëå](https://emojipedia.org/).

```{r env√≠o_chartplot}
api_create(ggplotly(gg2,
         tooltip = 'text'),
         filename='Gr√°fico Pok√©mon #yosigopublicando')
```
