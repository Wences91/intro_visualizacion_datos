---
title: "Untitled"
author: "Wenceslao Arroyo-Machado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plotly)
library(dplyr)
library(viridis)

df <- read.csv('data/pokemon.csv')
```

El objetivo de esta notebook es aprender los pilares de `ggplot2` y

# ggplot2

## 1. Introducci√≥n

**ggplot2** es un potente paquete para la elaboraci√≥n de gr√°ficos en R y que funciona a trav√©s de *pipelines* (el operador pipeline es +). Dentro de este flujo de trabajo existen varias funciones y par√°metros que son fundamentales para la elaboraci√≥n de un gr√°fico:

-   **ggplot()** - funci√≥n base para la construcci√≥n del gr√°fico

-   **geom** - funciones que especifican el tipo de representaci√≥n de los datos (puntos, l√≠neas, boxplots...) y lo a√±aden al gr√°fico mediante capas

-   **data** - par√°metro de que indica el dataframe a partir del cual se construira el gr√°fico

-   **aesthetics (aes)** - par√°metro en el que se especifican qu√© variables del dataset se incluyen en el gr√°fico y c√≥mo

De esta forma, para construir un gr√°fico *scatter plot* con nuestro datset, en el que queramos colocar los puntos de ataque (*attack*) en el eje x y los de defensa (*defense*) en el eje y, realizar√≠amos lo siguiente. Date cuenta de que por defecto orden ambos ejes de menor a mayor ü§î.

```{r ejemplo_1}
ggplot(data=df, aes(x=attack, y=defense)) +
  geom_point()
```

Todo lo especificado en `ggplot()` es heredado por el resto de funciones, aunque es posible pasar directamente los datos y variables en las funciones geom que usemos (√∫til para combinar diferentes visualizaciones, como veremos m√°s adelante ü§´).

```{r ejemplo_2}
ggplot() +
  geom_point(data=df, aes(x=attack, y=defense))
```

Es posible introducir en `aes()` tambi√©n una tercera o cuarta variable para establecer tama√±os o colores. Aunque en funci√≥n del geom que estemos usando puede tener variaciones. Consulta para ello la ayuda de cada funci√≥n üßê.

```{r help_geom}
help('geom_point')
```

En base a lo que admite `geom_point()` voy a incluir la en color la defensa (*defense*) y en tama√±o los puntos de vida (*hp*).

```{r ejemplo_3}
ggplot(data=df, aes(x=attack, y=defense, color=base_total, size=hp)) +
  geom_point()
```

Estos par√°metros no tienen que estar asociados a una variable, pueden ser una constante. Por ejemplo, se puede indicar que el tama√±o sea en todos los casos el mismo. Aunque en este caso es mejor indicarlo directamente en la funci√≥n y fuera de `aes()`.

```{r ejemplo_4}
ggplot(data=df, aes(x=attack, y=defense)) +
  geom_point(size=2, color='#ffc83d')
```

Algunos apuntes importantes antes de continuar:

1.  Es posible generar el gr√°fico en una variable para facilitar distintas pruebas ahorrando c√≥digo.

```{r ejemplo_5}
df_plot <- ggplot(data=df, aes(x=attack, y=defense, color=base_total))

df_plot +
  geom_point(size=2)
```

2.  Ten en cuenta que tipo de variable tienes, confundir variables discretas y continuas es com√∫n ü§ï. Si tenemos un variable de tipo `integer` autom√°ticamente la tomara como continua, pero si es discreta tenemos que modificarla antes.

    ```{r ejemplo_6}
    ggplot(data=df, aes(x=attack, y=defense, color=generation)) +
      geom_point(size=2)

    df$generation <- as.character(df$generation)
    ggplot(data=df, aes(x=attack, y=defense, color=generation)) +
      geom_point(size=2)
    ```

3.  Combinar dos gr√°ficos (capas) es muy sencillo, solo tienes que a√±adir dos geoms. Pero ten en cuenta que variables quieres usar, pues es posible que tengas que especificarlas directamente dentro de estas.

```{r ejemplo_7}
ggplot(data=df, aes(x=attack, y=defense, color=generation)) +
  geom_point(size=2)
```

## 2. geoms

Ahora que ya conocemos un poco la forma de trabajar b√°sica de `ggplot2`, vamos a conocer los principales gr√°ficos que podemos hacer.

### 2.1. L√≠neas - geom_line() y geom_smooth()

Podemos construir gr√°ficos de lineas con `geom_line()`, de manera obligatoria es necesario indicar la posici√≥n de x e y. Por ejemplo, la evoluci√≥n del ataque (*attack*) de los Pok√©mon por orden de posici√≥n en la Pok√©dex (*pokedex_number*), coloreando las l√≠neas en base a la generaci√≥n (*generation*).

```{r ejemplo_8}
ggplot(data=df, aes(x=pokedex_number, y=attack, color=generation)) +
  geom_line()
```

Es posible hacer lineas de regresi√≥n mediante `geom_smooth()`. Por defecto estimar√° el tipo de regresi√≥n que mejor se ajusta.

```{r ejemplo_9}
ggplot(data=df, aes(x=pokedex_number, y=attack, color=generation)) +
  geom_line() +
  geom_smooth()
```

F√≠jate en el ejemplo, que agrupa por generaci√≥n porque de base le digo que establezca dicha diferencia ü•¥. Si quisiera una l√≠nea de regresi√≥n general, una opci√≥n ser√≠a hacer esa distinci√≥n de color espec√≠fica de `geom_line()`.

```{r ejemplo_10}
ggplot(data=df, aes(x=pokedex_number, y=attack)) +
  geom_line(aes(color=generation)) +
  geom_smooth()
```

### 2.2. Puntos - geom_point()

Esta opci√≥n ya la vimos antes, para hacer un *scatter plot* solo tenemos que usar `geom_point()` y de manera obligatoria incluir las posiciones de x e y. Por ejemplo, el ataque (*attack*) en x y el ataque especial (*sp_attack*) en y, coloreo si es legendario o no (*is_legendary*)*.*

\*antes tengo que transformarla en discreta ü§´

```{r ejemplo_11}
df$is_legendary <- as.character(df$is_legendary)

ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point()
```

### 2.3. Barras - geom_bar() y geom_col()

Aqu√≠ tenemos dos opciones. Por un lado `geom_bar()` permite generar barras de frecuencia de una variable. Solo necesitas especificar la variable en x o y. Por ejemplo, la frecuencia de Pok√©mon por primer tipo (*type1*).

```{r ejemplo_12}
ggplot(data=df, aes(x=type1)) +
  geom_bar()
```

Mientras que en `geom_col()` en lugar de calcular la funci√≥n la altura en base a la frecuencia, esta debe venir dada. Es necesario tanto x como y. Para este ejemplo voy a crear un dataframe nuevo con los promedios de ataque por tipo 1.

```{r ejemplo_13}
df_avg <- df[,c('type1', 'attack')] %>%
  group_by(type1) %>%
  summarise(attack = mean(attack))

ggplot(data=df_avg, aes(x=type1, y=attack)) +
  geom_col()
```

### 2.4. Histograma - geom_histogram()

Realizar un histograma es muy sencillo üôÇ con la funci√≥n `geom_histogram()`. Solo es necesario indicar la variable en x o y. Puedes establecer el n√∫mero de bins con el par√°metro `bins`. Por ejemplo, el histograma de velocidad (speed) de los Pok√©mon usando 25 bins.

```{r ejemplo_14}
ggplot(data=df, aes(x=speed)) +
  geom_histogram(bins=25)
```

### 2.5. Boxplot

Los diagramas de cajas y bigotes son un cl√°sico y aqu√≠ puedes hacerlo con `geom_boxplot()` solo necesitas indicar la variable en x o y. Aunque ojo üëÅÔ∏è‚Äçüó®Ô∏è puedes dividir esta variable de acuerdo a una segunda. Por ejemplo, el ataque especial (*sp_attack*) por primer tipo (*type1*).

```{r ejemplo_15}
ggplot(data=df, aes(x=type1, y=sp_attack)) +
  geom_boxplot()
```

## 3. Personalizaci√≥n

### 3.1. Etiquetas

Como te estar√°s dando cuenta, en gr√°ficos como los de puntos no aparecen las etiquetas con los nombres. Introducirlo es muy sencillo con `geom_text()` indicando en el par√°metro `label` la variable que va a salir junto al punto. Por ejemplo, incluir en gr√°fico del inicio los nombres de los Pok√©mon con m√°s de 130 de ataque y defensa (para que sea legible üòµ).

```{r ejemplo_16}
ggplot(data=df, aes(x=attack, y=defense, color=base_total)) +
  geom_point() +
  geom_text(data=df[which(df$attack>130 & df$defense>130),], aes(x=attack, y=defense, label=name))
```

### 3.2. Colores

Podemos establecer escalas de color de forma manual una vez indicado que esta escala viene dada por una variable. En el caso de variables continuas podemos usar `scale_color_gradient()` para establecer un degradado de color.

```{r ejemplo_17}
ggplot(data=df, aes(x=attack, y=defense, color=base_total)) +
  geom_point() +
  scale_color_gradient(low='blue', high='red')
```

De hecho, existen muchos paquetes complementarios a `ggplot2` que a√±aden muchas posibilidades. Por ejemplo, con `viridis` podemos usar la tradicional escala de colores con la funci√≥n `scale_color_viridis()`.

```{r ejemplo_18}
ggplot(data=df, aes(x=attack, y=defense, color=base_total)) +
  geom_point() +
  scale_color_viridis()
```

En el caso de variable discretas es muy sencillo, con `scale_color_manual()` podemos hacerlo simplemente indicando en `values` a que valor corresponde cada color.

```{r ejemplo_19}
ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25'))
```

### 3.3. Nombres

Por si no te diste cuenta, estos gr√°ficos incluyen por defecto los nombres de las variables en los ejes üôÉ. Este problema se soluciona r√°pidamente con `labs()` indicando para cada variable el nombre exacto que queremos, e incluso podemos introducir un t√≠tulo.

```{r ejemplo_20}
ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25')) +
  labs(x='Ataque', y='Ataque especial', title='Scatter plot de ataque y ataque especial de los Pok√©mon', color='Legendario')
```

### 3.4. Temas

A tu gr√°fico ya le queda poco para ser pro ü•≥. Puedes usar alguno de los temas que `ggplot2` incluye para mejorar el estilo del gr√°fico. Yo voy a usar `theme_classic()`.

```{r ejemplo_21}
ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary)) +
  geom_point() +
  scale_color_manual(values=c('0'='#57a1d1', '1'='#bb3f25')) +
  labs(x='Ataque', y='Ataque especial', title='Scatter plot de ataque y ataque especial de los Pok√©mon', color='Legendario') +
  theme_classic()
```

### 3.5. Editor visual

```{r ejemplo_21}
plot_ly(data=df, x=~attack, y=~sp_attack, split=~is_legendary, type='scatter', mode='markers')
```

```{r ejemplo_21}
ggplotly(ggplot(data=df, aes(x=attack, y=sp_attack, color=is_legendary, text=name)) +
  geom_point())


ggplotly(ggplot(data=df, aes(x=speed)) +
  geom_histogram(bins=25))
```
